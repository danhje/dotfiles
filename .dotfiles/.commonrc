export PATH=~/.local/bin:~/.poetry/bin:$PATH
export MCFLY_RESULTS=50
export MCFLY_FUZZY=true

# Meta
alias updot="source <(curl -fsSL https://raw.githubusercontent.com/danhje/dotfiles/main/install.sh)"

# cd
alias cd..='cd ..'
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias .....='cd ../../../..'
alias ......='cd ../../../../..'
alias .......='cd ../../../../../..'
alias .2='cd ../..'
alias .3='cd ../../..'
alias .4='cd ../../../..'
alias .5='cd ../../../../..'
alias .6='cd ../../../../../..'
alias .7='cd ../../../../../../..'

# git
alias ga="git add"
__git_complete ga _git_add
alias gd="git diff"
__git_complete gd _git_diff
alias gds="git diff --staged"
alias gb="git branch"
__git_complete gb _git_branch
alias gba="git branch -a"
alias gch="git checkout"
__git_complete gch _git_checkout
alias gs="git status"
__git_complete gs _git_status
alias gc="git commit"
__git_complete gc _git_commit
alias gl="git log"
__git_complete gl _git_log
alias glo="git log --oneline --graph"
alias gp="git push"
__git_complete gp _git_push
alias gl="git pull"
__git_complete gl _git_pull
alias gr="git reset"
__git_complete gr _git_reset
alias grh="git reset --hard"
__git_complete grh _git_reset
alias gf="git fetch"
__git_complete gf _git_fetch
alias gfa="git fetch --all"
__git_complete gfa _git_fetch
alias gamend="git commit --amend --no-edit"
alias gforce="git push --force-with-lease"
alias grm="git ls-files -c --ignored --exclude-standard -z | xargs -0 git rm --cached"  # Forget ignored
alias gw="git worktree"
__git_complete gw _git_worktree
alias gwa="git worktree add"
__git_complete gwa _git_checkout  # Hack to get branches from tab completion
alias gwl="git worktree list"
alias gwr="git worktree remove"
__git_complete gwr _git_checkout  # Hack to get branches from tab completion
alias gcar="git config --add remote.origin.fetch '+refs/heads/*:refs/remotes/origin/*'"

# poetry
alias poetry-rebuild='poetry env remove $(poetry env list | awk "{print \$1;}") && poetry install'
alias pru="poetry run"
alias psh="poetry shell"
alias pad="poetry add"

# docker [compose]
alias up="docker compose up"
alias down="docker compose down"

# other
alias init="git init && pre-commit install && poetry install"
alias pre="pre-commit install && pre-commit run --all-files"
alias re-source='. ~/.zshrc 2>/dev/null ; . ~/.bashrc 2>/dev/null'
alias p='sb pycharm nosplash .'
alias lk="exa -lhar -s modified"
alias c="clear"
alias grep="grep --color=auto"
alias t="poetry run pytest"
alias listfunc="compgen -A function | grep \"^[^_]\""
alias now='date +"%s"'


function expsec () {
    # Export secret. Looks up argument in pass, and exports value
    if [ ! -v $1 ]; then
        export "$1"="$(pass show "$1")"
    fi
}


function crush() {
    # Kill process listening on specified port (default = 8000)
    port=$*
    if [ -z "$port" ]; then
        port=8000
    fi
    kill $(lsof -i tcp:$port | awk 'NR==2 {print $2}')
}


function trash() {
    # Move file or folder to ~/.trash. If already present, append .~<i>~
    [ ! -d ~/.trash ] && mkdir ~/.trash
    mv $* ~/.trash --backup=numbered
}


function sr() {
    # Set remote to trach current branch.
    if [ $(git remote | wc -l) -ne 1 ]; then
        return
    fi
    branch=$(git branch --show-current)
    remote=$(git remote)
    git branch --set-upstream-to=$remote/$branch $branch
}


function sb() {
    # Starts a process in the background, suppressing any stdout / stderr output.
    $* >/dev/null 2>&1 &
}


function poetry-update() {
# Remove and re-add all (non-dev) requirements. PS: This function block must be un-indented for heredoc termination to work. 
deps=$(
python3 << EOF
import sys
with open("pyproject.toml", "r") as f:
    lines = f.readlines()
in_dep_section = False
pkgs = []
for line in lines:
    if "[tool.poetry.dependencies]" in line: in_dep_section = True
    elif line[0] == "[": in_dep_section = False
    elif in_dep_section:
        try:
            pkgs.append(line.split("=")[0].strip())
        except IndexError:
            ...
pkgs.remove("python")
sys.stdout.write(" ".join(pkgs))
sys.stdout.flush()
EOF
) && poetry remove $deps && poetry add $deps
}


function poetry-update-dev() {
# Remove and re-add all dev requirements. PS: This function block must be un-indented for heredoc termination to work.
deps=$(
python3 << EOF
import sys
with open("pyproject.toml", "r") as f:
    lines = f.readlines()
in_dep_section = False
pkgs = []
for line in lines:
    if "[tool.poetry.dev-dependencies]" in line: in_dep_section = True
    elif line[0] == "[": in_dep_section = False
    elif in_dep_section:
        try:
            pkgs.append(line.split("=")[0].strip())
        except IndexError:
            ...
pkgs.remove("python")
sys.stdout.write(" ".join(pkgs))
sys.stdout.flush()
EOF
) && poetry remove --dev $deps && poetry add --dev $deps
}


# Source local rc. Should remain at the bottom.
if [ -f ~/.localrc ]; then
    . ~/.localrc
fi
